(()=>{"use strict";var e={481:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.redisConnection=void 0,t.getRedisConfig=i;const n=r(749),o=6379,s="localhost";function i(){const{REDIS_HOST:e=s,REDIS_PORT:t=o,REDIS_PASSWORD:r,REDIS_TLS:i,REDIS_DB:a}=process.env;return n.logger.info("File: redis.ts 🔌, Line: 15, Function: getRedisConfig;",{host:e,port:t,tls:"true"===i,db:a}),{host:e,port:Number(t),password:r,tls:"true"===i?{}:void 0,db:a?Number(a):void 0}}t.redisConnection=i()},361:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.task=function(e={}){return function(t,r,i){i.value;const a=e.name||r;return i.value=async function(...t){o.logger.info("File: task.ts 🎯, Line: 20, Function: task decorator;",{taskName:a,args:t});const r={id:e.id,priority:e.priority,maxRetries:e.maxRetries,retryDelay:e.retryDelay,timeout:e.timeout,schedule:e.schedule,queue:e.queue};try{const e=s.cleo.getQueueManager(),i=await e.addTask(a,t[0],r);return o.logger.info("File: task.ts ✅, Line: 40, Function: task decorator;",{taskId:i.id,taskName:a,state:n.TaskState.PENDING}),i}catch(e){throw o.logger.error("File: task.ts ❌, Line: 48, Function: task decorator;",{taskName:a,error:e}),e}},i}};const n=r(815),o=r(749),s=r(783)},783:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Worker=t.redisConnection=t.LogLevel=t.TaskPriority=t.TaskState=t.cleo=void 0;const n=r(361),o=r(433),s=r(587);Object.defineProperty(t,"Worker",{enumerable:!0,get:function(){return s.Worker}});const i=r(815);Object.defineProperty(t,"TaskState",{enumerable:!0,get:function(){return i.TaskState}}),Object.defineProperty(t,"TaskPriority",{enumerable:!0,get:function(){return i.TaskPriority}}),Object.defineProperty(t,"LogLevel",{enumerable:!0,get:function(){return i.LogLevel}});const a=r(749),u=r(481);Object.defineProperty(t,"redisConnection",{enumerable:!0,get:function(){return u.redisConnection}});class c{static instance;queueManager;worker=null;isConfigured=!1;constructor(){a.logger.info("File: index.ts 📦, Line: 15, Function: constructor; Initializing Cleo instance"),this.queueManager=new o.QueueManager("default")}static getInstance(){return c.instance||(a.logger.info("File: index.ts 🔄, Line: 22, Function: getInstance; Creating new Cleo instance"),c.instance=new c),c.instance}configure(e){try{if(a.logger.info("File: index.ts ⚙️, Line: 36, Function: configure; Configuring Cleo with redis settings",{host:e.redis.host,port:e.redis.port}),!e.redis.host||!e.redis.port)throw new Error("Redis host and port are required");process.env.REDIS_HOST=e.redis.host,process.env.REDIS_PORT=e.redis.port.toString(),e.redis.password&&(process.env.REDIS_PASSWORD=e.redis.password),e.redis.tls&&(process.env.REDIS_TLS="true"),e.redis.db&&(process.env.REDIS_DB=e.redis.db.toString()),e.worker&&(a.logger.info("File: index.ts 👷, Line: 51, Function: configure; Initializing worker"),this.worker=new s.Worker("default",e.worker)),this.isConfigured=!0,a.logger.info("File: index.ts ✅, Line: 56, Function: configure; Cleo configuration complete")}catch(e){throw a.logger.error("File: index.ts ❌, Line: 58, Function: configure; Configuration failed",{error:e}),e}}getQueueManager(){if(!this.isConfigured)throw a.logger.error("File: index.ts ⚠️, Line: 64, Function: getQueueManager; Cleo must be configured before using"),new Error("Cleo must be configured before using");return this.queueManager}getWorker(){return this.worker}task=n.task}const l=c.getInstance();t.cleo=l},433:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueueManager=void 0;const n=r(377),o=r(815),s=r(749),i=r(481);t.QueueManager=class{queues;constructor(e){s.logger.info("File: queueManager.ts 🎯, Line: 9, Function: constructor;",{defaultQueueName:e}),this.queues=new Map,this.queues.set(e,new n.Queue(e,{connection:i.redisConnection}))}async addTask(e,t,r={}){const a=r.queue||"default";let u=this.queues.get(a);u||(s.logger.info("File: queueManager.ts 🆕, Line: 23, Function: addTask;",{queueName:a,message:"Creating new queue"}),u=new n.Queue(a,{connection:i.redisConnection}),this.queues.set(a,u));const c={id:r.id||`${e}-${Date.now()}`,name:e,data:t,options:r,state:o.TaskState.PENDING,retryCount:0,createdAt:new Date,updatedAt:new Date};s.logger.info("File: queueManager.ts ➕, Line: 42, Function: addTask;",{taskId:c.id,taskName:c.name,queueName:a});const l={priority:r.priority,attempts:r.maxRetries,backoff:{type:"exponential",delay:r.retryDelay||1e3},removeOnComplete:r.timeout?{age:r.timeout,count:1e3}:void 0,repeat:r.schedule?{pattern:r.schedule}:void 0};return await u.add(e,c,l),c}async getTask(e,t="default"){const r=this.queues.get(t);if(!r)return s.logger.error("File: queueManager.ts ❌, Line: 65, Function: getTask;",{queueName:t,message:"Queue not found"}),null;const n=await r.getJob(e);return n?n.data:(s.logger.warn("File: queueManager.ts ⚠️, Line: 73, Function: getTask;",{taskId:e,queueName:t,message:"Task not found"}),null)}async removeTask(e,t="default"){const r=this.queues.get(t);if(!r)return s.logger.error("File: queueManager.ts ❌, Line: 87, Function: removeTask;",{queueName:t,message:"Queue not found"}),!1;const n=await r.getJob(e);return n?(await n.remove(),s.logger.info("File: queueManager.ts 🗑️, Line: 103, Function: removeTask;",{taskId:e,queueName:t,message:"Task removed"}),!0):(s.logger.warn("File: queueManager.ts ⚠️, Line: 95, Function: removeTask;",{taskId:e,queueName:t,message:"Task not found"}),!1)}async close(){s.logger.info("File: queueManager.ts 🔒, Line: 112, Function: close;",{message:"Closing all queues"});const e=Array.from(this.queues.values()).map((e=>e.close()));await Promise.all(e),this.queues.clear()}}},815:(e,t)=>{var r,n,o,s,i;Object.defineProperty(t,"__esModule",{value:!0}),t.QueueEvent=t.WorkerState=t.LogLevel=t.TaskPriority=t.TaskState=void 0,function(e){e.PENDING="PENDING",e.RUNNING="RUNNING",e.SUCCESS="SUCCESS",e.FAILURE="FAILURE",e.RETRY="RETRY",e.SCHEDULED="SCHEDULED",e.CANCELLED="CANCELLED"}(r||(t.TaskState=r={})),function(e){e[e.LOW=1]="LOW",e[e.NORMAL=2]="NORMAL",e[e.HIGH=3]="HIGH",e[e.CRITICAL=4]="CRITICAL"}(n||(t.TaskPriority=n={})),function(e){e.ERROR="error",e.WARN="warn",e.INFO="info",e.DEBUG="debug"}(o||(t.LogLevel=o={})),function(e){e.IDLE="IDLE",e.BUSY="BUSY",e.STOPPED="STOPPED",e.ERROR="ERROR"}(s||(t.WorkerState=s={})),function(e){e.TASK_ADDED="TASK_ADDED",e.TASK_STARTED="TASK_STARTED",e.TASK_COMPLETED="TASK_COMPLETED",e.TASK_FAILED="TASK_FAILED",e.TASK_RETRYING="TASK_RETRYING",e.WORKER_CONNECTED="WORKER_CONNECTED",e.WORKER_DISCONNECTED="WORKER_DISCONNECTED"}(i||(t.QueueEvent=i={}))},749:function(e,t,r){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.logger=void 0,t.log=function(e,t,r){a.log(e,t,r)};const o=n(r(306)),s=r(815),i=o.default.format.combine(o.default.format.timestamp(),o.default.format.json(),o.default.format.printf((({timestamp:e,level:t,message:r,...n})=>{const o=Object.keys(n).length?JSON.stringify(n):"";return`${e} [${t.toUpperCase()}]: ${r} ${o}`}))),a=o.default.createLogger({level:process.env.LOG_LEVEL||s.LogLevel.INFO,format:i,transports:[new o.default.transports.Console({format:o.default.format.colorize({all:!0})}),new o.default.transports.File({filename:"logs/error.log",level:s.LogLevel.ERROR}),new o.default.transports.File({filename:"logs/combined.log"})]});t.logger=a,a.requestTracker=(e,t,r)=>{const n=Date.now();t.on("finish",(()=>{const r=Date.now()-n;a.info("File: logger.ts 🌐, Line: 33, Function: requestTracker;",{method:e.method,url:e.url,status:t.statusCode,duration:`${r}ms`})})),r()}},587:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Worker=void 0;const n=r(377),o=r(853),s=r(815),i=r(749),a=r(481);t.Worker=class{worker;registry;state=s.WorkerState.IDLE;constructor(e,t){i.logger.info("File: worker.ts 🚀, Line: 14, Function: constructor;",{queueName:e,config:t}),this.registry=new o.TaskRegistry,this.worker=new n.Worker(e,this.processTask.bind(this),{connection:a.redisConnection,concurrency:t.concurrency||1}),this.setupEventHandlers()}setupEventHandlers(){this.worker.on("completed",(e=>{e&&i.logger.info("File: worker.ts ✅, Line: 29, Function: setupEventHandlers;",{jobId:e.id,state:s.TaskState.SUCCESS})})),this.worker.on("failed",((e,t)=>{i.logger.error("File: worker.ts ❌, Line: 36, Function: setupEventHandlers;",{jobId:e?.id,error:t,state:s.TaskState.FAILURE})})),this.worker.on("error",(e=>{i.logger.error("File: worker.ts 💥, Line: 44, Function: setupEventHandlers;",{error:e,state:s.WorkerState.ERROR}),this.state=s.WorkerState.ERROR}))}async processTask(e){try{i.logger.info("File: worker.ts 🔄, Line: 54, Function: processTask;",{jobId:e.id,state:s.TaskState.RUNNING}),this.state=s.WorkerState.BUSY;const t=e.data,r=this.registry.getTaskHandler(t.name);if(!r)throw new Error(`No handler registered for task: ${t.name}`);const n=await r(t.data);return this.state=s.WorkerState.IDLE,i.logger.info("File: worker.ts ✅, Line: 69, Function: processTask;",{jobId:e.id,taskName:t.name,result:n}),n}catch(t){throw this.state=s.WorkerState.ERROR,i.logger.error("File: worker.ts ❌, Line: 78, Function: processTask;",{jobId:e.id,error:t}),t}}registerTask(e,t){this.registry.registerTask(e,t)}getState(){return this.state}async close(){i.logger.info("File: worker.ts 🔒, Line: 90, Function: close;",{state:s.WorkerState.STOPPED}),this.state=s.WorkerState.STOPPED,await this.worker.close()}}},853:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.TaskRegistry=void 0;const n=r(749);t.TaskRegistry=class{tasks;constructor(){this.tasks=new Map,n.logger.info("File: taskRegistry.ts 📝, Line: 8, Function: constructor;",{message:"Task registry initialized"})}registerTask(e,t){n.logger.info("File: taskRegistry.ts ➕, Line: 15, Function: registerTask;",{taskName:e}),this.tasks.set(e,t)}getTaskHandler(e){const t=this.tasks.get(e);return t||n.logger.warn("File: taskRegistry.ts ⚠️, Line: 24, Function: getTaskHandler;",{taskName:e,message:"Task handler not found"}),t}async execute(e){const t=this.getTaskHandler(e.name);if(!t){const t=`No handler registered for task: ${e.name}`;throw n.logger.error("File: taskRegistry.ts ❌, Line: 35, Function: execute;",{taskName:e.name,error:t}),new Error(t)}try{n.logger.info("File: taskRegistry.ts 🔄, Line: 43, Function: execute;",{taskName:e.name,taskId:e.id});const r=await t(e.data);return n.logger.info("File: taskRegistry.ts ✅, Line: 50, Function: execute;",{taskName:e.name,taskId:e.id,result:r}),r}catch(t){throw n.logger.error("File: taskRegistry.ts ❌, Line: 58, Function: execute;",{taskName:e.name,taskId:e.id,error:t}),t}}}},377:e=>{e.exports=require("bullmq")},306:e=>{e.exports=require("winston")}},t={},r=function r(n){var o=t[n];if(void 0!==o)return o.exports;var s=t[n]={exports:{}};return e[n].call(s.exports,s,s.exports,r),s.exports}(783);module.exports=r})();